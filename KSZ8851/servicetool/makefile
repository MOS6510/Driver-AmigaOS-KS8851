#
# Amiga 1200+ Ethernet driver KSZ8851 
#
# 2019 by Heiko Pr√ºssing
#

SOURCE_TESTTOOL   = testtool.c ks8851_mll.c
HDR 					:= $(wildcard *.h) 

COMPILE_MODE		=
COMPILE_MODE		+= -DDEBUG=1

CC_OPTS           =  $(COMPILE_MODE)

# "strip" (from tool chain) command does not work but linker option works ????
# Use it to strip symbols from device only...
STRIP_OPTS 		 = -s

#AMIGA_EXPLORER = ./Software_Tests_and_Tools/lxamiga.pl

#If not given via command line build for "MC68000"
ifeq ($(ARCH),)
	ARCH=000
endif	

BUILDDIR=build/build-$(ARCH)

# Cross compile with MacOSX and GCC 3.4.1
CCPATH                       = /usr/local/cross-tools/m68k-amigaos
CC                           = $(CCPATH)/bin/gcc 
CPP                          = $(CCPATH)/bin/g++
AR                           = $(CCPATH)/bin/ar
RANLIB							  = $(CCPATH)/bin/ranlib
SHELL                        = sh
LINKER                       = $(CCPATH)/bin/gcc
AOS_INCLUDES                 = -Iincludes/os-include39/include/include_h 
OS_INCLUDES                  = -Iincludes -Iincludes/sana -Iincludes/libnix -Iincludes/mui
PRJ_INCLUDES                 = -I. -IEtherPrefs
CC_OPTS                      += -Os \
										-fstrength-reduce \
                              -nostdinc $(AOS_INCLUDES) -I$(CCPATH)/include -I$(CCPATH)/sys-include $(OS_INCLUDES) $(PRJ_INCLUDES)  \
                              -fno-builtin-printf \
                              -noixemul \
                              -std=c99 \
                              -Wall \
                              -fomit-frame-pointer \
                              -m68$(ARCH) \
                              -msoft-float                               
                              
CPPFLAGS								+= -Os -D__cplusplus $(AOS_INCLUDES) $(OS_INCLUDES) -I. \
										 -m68$(ARCH) 
                                                            
LINKER_OPTS                	= -Llibs -nostdlib -noixemul -lnix -lamiga -lstubs 

OBJECTS_TESTTOOL       			= $(patsubst %.c, $(BUILDDIR)/%.o, $(SOURCE_TESTTOOL))

ADFIMAGE								= Amiga1200+.adf

.PHONY: all distribution

all: builddir $(BUILDDIR)/ksz8851 $(BUILDDIR)/$(ADFIMAGE)

$(BUILDDIR)/$(ADFIMAGE):
	@echo "Create ADF image..."
	@$(XDFTOOL) $@ format "Amiga1200+" + makedir "network" + write $(BUILDDIR)/ksz8851 "network"
	@$(XDFTOOL) $@ list
	
     
builddir:
	@echo "Create build directories..."
	@mkdir -p $(BUILDDIR)
		
$(BUILDDIR)/ksz8851:	$(OBJECTS_TESTTOOL)
		@echo "Linking       " $@
		@$(LINKER) $^ $(STRIP_OPTS) -o $@ -noixemul -Llibs -O2 -Wl,-Map,$@.map 
		
		
# Installs device on real Amiga via "Amiga Explorer"
install:
		$(AMIGA_EXPLORER) -l || true
		@sleep 1
		$(AMIGA_EXPLORER) -u RAD:/ksz8851 || true
		@sleep 1
		$(AMIGA_EXPLORER) -s $(BUILDDIR)/ksz8851 RAD:/ksz8851	
		

clean:
		rm -r -f -d $(BUILDDIR)/* *.o *.s *.aobj *.map mapfile

#.c.o:
$(BUILDDIR)/%.o:%.c $(HDR)
	@echo "Compiling C   " $< " (cpu=68"$(ARCH)")"
	@$(CC) -c -nostdinc $(CC_OPTS) -o $@ $< 

.c.s:
	$(CC) -S -nostdinc $(CC_OPTS) $(COMPILE_MODE) -o $@ $< 
	
.cpp.s:
	$(CPP) -S $(CPPFLAGS) $(COMPILE_MODE) -o $@ $< 

